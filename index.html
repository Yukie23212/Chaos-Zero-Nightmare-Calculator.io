<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faint Memory Tracker Updated#15/11/2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            /* Ensure bottom padding is enough for the fixed button container */
            padding-bottom: 9rem; 
        }
        .card {
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* New style for the fixed/floating results container */
        #floatingResultsContainer {
            position: fixed;
            top: 5rem; /* Space from the top */
            right: 1.5rem; /* Space from the right edge */
            z-index: 50;
            max-width: 200px; /* Limit width */
            width: 100%;
            
            /* Hide on small screens to prevent overlap or clutter */
            display: none; 
        }

        /* Make it visible only on medium screens and up */
        @media (min-width: 768px) {
            #floatingResultsContainer {
                display: block;
            }
        }

        .floating-result-box {
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        .input-group input[type="number"], .input-group select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .calculator-wrapper {
            max-width: 42rem; 
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        #navArrowsContainer {
            width: 100vw;
            left: 50%;
            transform: translateX(-50%);
            top: 0;
            bottom: 0;
            z-index: 50; 
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        /* New fixed button container style */
        #floatingResetContainer {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 60;
            /* Responsive placement for smaller screens */
            @media (max-width: 640px) {
                bottom: 1rem;
                right: 1rem;
                width: calc(100% - 2rem);
            }
        }
        /* Ensure buttons stack correctly on small screens */
        @media (max-width: 640px) {
            #floatingResetContainer {
                flex-direction: column-reverse; /* Put the main action button (Red) on bottom */
            }
            #floatingResetContainer button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <div id="resetModal" class="modal hidden fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 bg-opacity-75" aria-modal="true" role="dialog">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-11/12 max-w-md transform transition-all">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-800 mb-4">Confirm Reset</h3>
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            
            <div id="resetOptions" class="space-y-4">
            </div>

            <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer">
                    <input type="checkbox" id="skipConfirmationCheckbox" onchange="toggleModalSkip(this.checked)" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span>Don't show this confirmation again.</span>
                </label>
            </div>
            
            <button onclick="hideResetModal()" class="w-full mt-4 py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-lg transition duration-150">
                Cancel
            </button>
        </div>
    </div>


    <div id="navArrowsContainer" class="fixed inset-y-0 pointer-events-none flex justify-center items-center">
        <div class="calculator-wrapper flex justify-between h-full items-center px-4">
            
            <button id="prevCharacterBtn" class="pointer-events-auto bg-white/80 backdrop-blur-sm hover:bg-white/95 p-3 md:p-4 rounded-full shadow-xl border border-gray-300 transition duration-150 ease-in-out text-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 -ml-8 md:-ml-12 lg:-ml-16" onclick="switchSlot(-1)" title="Previous Character Slot">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            
            <button id="nextCharacterBtn" class="pointer-events-auto bg-white/80 backdrop-blur-sm hover:bg-white/95 p-3 md:p-4 rounded-full shadow-xl border border-gray-300 transition duration-150 ease-in-out text-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-500/50 -mr-8 md:-mr-12 lg:-mr-16" onclick="switchSlot(1)" title="Next Character Slot">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                </svg>
            </button>
        </div>
    </div>
    <main class="calculator-wrapper px-4 pt-8">
        <div class="w-full card rounded-xl p-6 md:p-8">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-2">CZN Faint Memory Calculator</h1>
            <p class="text-sm text-gray-500 mb-6">Select a character to view and edit their specific run data. <br> (Please note that which character you selected is not a matter, the result is still the same, just better for tracking.) The value is save on LocalStorage.</p>


            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8 p-4 bg-indigo-50 rounded-xl border border-indigo-200 shadow-inner">
                <div class="input-group flex-grow">
                    <label for="slotSelector" class="block text-xs font-medium text-indigo-700 mb-1">Active Slot</label>
                    <select id="slotSelector" onchange="handleSlotSwitch(this.value)" class="font-semibold text-lg py-2">
                        <option value="0">Slot 1: Character Name</option>
                        <option value="1">Slot 2: Character Name</option>
                        <option value="2">Slot 3: Character Name</option>
                    </select>
                </div>
                
                <div class="input-group flex-grow">
                    <label for="characterPicker" class="block text-xs font-medium text-indigo-700 mb-1">Select Character for Active Slot</label>
                    <select id="characterPicker" onchange="handleCharacterSelect(this.value)" class="font-semibold text-lg py-2">
                    </select>
                </div>
            </div>
            <div id="summaryBar" class="grid grid-cols-3 gap-3 mb-8">
            </div> 
            <div id="calculatorForm" class="space-y-6">
                </div>
                <div id="floatingResultsContainer">
                    
                    <div id="characterStatus" class="p-3 mb-3 bg-indigo-600 text-white text-base font-bold rounded-lg shadow-md text-center">
                        Editing: Character Name
                    </div>
                    <div class="floating-result-box space-y-3">
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3 text-center">Current Run Status</h3>
                        
                        <div class="text-center p-2 rounded-lg bg-indigo-50 border border-indigo-300">
                            <p class="text-xs font-semibold text-indigo-600">Limit (Eff. Tier)</p>
                            <p id="limitDisplay" class="text-lg font-bold text-indigo-700 mt-0">70</p>
                        </div>
                        
                        <div class="text-center p-2 rounded-lg bg-indigo-50 border border-indigo-300">
                            <p class="text-xs font-semibold text-indigo-600">Total Faint Memory</p>
                            <p id="totalPointsDisplay" class="text-lg font-bold text-indigo-700 mt-0">0</p>
                        </div>
                        
                        <div class="text-center p-2 rounded-lg border-2 mt-3" id="statusBox">
                            <p class="text-xs font-semibold text-gray-800">Status</p>
                            <p id="statusDisplay" class="text-lg font-extrabold text-green-600 mt-0">SAFE</p>
                        </div>
                    </div>
                </div>

        </div>
        
        <div class="mt-8 p-6 md:p-8 card rounded-xl">
            <button id="guideToggleBtn" class="flex justify-between items-center w-full text-left text-xl font-bold text-gray-800 focus:outline-none" onclick="toggleGuide()">
                How to Use This Calculator (Click to Toggle)
                <svg id="toggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div id="guideContent" class="mt-4 border-t pt-4 text-gray-700 hidden">
                <h3 class="font-semibold text-lg mb-2">A Brief Guide How to use:</h3>
                <ol class="list-decimal list-inside space-y-3 pl-4">
                    <li>
                        <p class="font-medium"><strong>Character Selection & Tracking:</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm text-gray-600">
							<li>you can use the arrow left or right to switch to other character.</li>
                            <li>Use the "Active Slot" dropdown to select the slot you are currently editing.</li>
                            <li>Use the "Select Character" dropdown to assign any character to the active slot. Inputs are saved per character.</li>
                            <li>The fixed bar at the bottom-left corner of the screen shows the name of the character currently being edited.</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium"><strong>Point Limit Modifiers (Section 1):</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm text-gray-600">
                            <li>Set the "Base Difficulty Tier" to determine the "Run Point Limit".</li>
							<li>if you enable nightmare mode, check "Nightmare Mode"</li>
							<li>if you enable "Codex Modifiers" (+0 to +2). </li>
							<li>Somehow it difficult to explain about "Codex Modifiers" so, I recommend stick with "Base Difficulty Tier" and "Nightmare Mode" </li>
                            <li>example: Set "Base Difficulty Tier" to 6, with nightmare mode (+1) check. all total = Tier 7 with 90 faint point. don't touch "Codex Modifiers" it will add the number twice if you don't know how it work.</li>
                            <details class="ml-4 mt-2 text-sm text-gray-600 border-l-2 border-gray-300 pl-2">
                                <summary class="cursor-pointer font-medium">More details (click to expand) " I'm tired so, I would leave it like this.</summary>
                                <p class="mt-2">
                                    Point Limit Calculation: Effective Tier ModifiersThe ultimate goal of Section 1 is to determine the Effective Tier of your run, as the Run Point Limit is calculated using the formula: $30 + 10 \times (\text{Effective Tier} - 1)$. 
                                    The Effective Tier is the sum of the three fields: Base Difficulty Tier + Nightmare Mode (+1) + Codex Modifiers (+X).To account for the nature of a Codex Chaos run which grants an inherent +1 bonus to the base tier compared to a 
                                    Normal Chaos run of the same difficulty you may choose one of the two input methods below:Method A: Direct Tier Entry (Recommended for Simplicity)This method treats the Base Difficulty Tier field as the actual starting tier of the run, 
                                    rendering the Codex Modifiers field unnecessary.Base Difficulty Tier: Select the tier that your run starts at.For a Difficulty 5 Normal Chaos run, select Tier 5.For a Difficulty 5 Codex Chaos run, select Tier 6.Codex Modifiers (Tier +X): Select None (+0). This ensures the Codex bonus is not added twice.Nightmare Mode: 
                                    Check the box if applicable (this will add $+1$ Tier to the total).Method B: Using the Codex Modifier (Recommended for Tracking)This method uses the Base Difficulty Tier field to reflect the displayed difficulty number and uses the Codex Modifiers field to account for the bonus provided by the Codex mode.Base Difficulty 
                                    Tier: Select the difficulty number that was displayed in the selection screen (e.g., for Difficulty 5, select Tier 5).Nightmare Mode: Check the box if applicable (this will add $+1$ Tier).Codex Modifiers (Tier +X): 
                                    Set this field to Mild (+1) to account for the base tier bonus provided by playing a Codex run. This value should typically be set to +1 for all Codex runs, regardless of Nightmare Mode.
                                </p>
                              </details>
                        </ul>
                    </li>
                    <li>
                        <p class="font-medium"><strong>Faint Memory Calculation (Sections 2, 3, & 4):</strong></p>
                        <ul class="list-disc list-inside ml-4 text-sm text-gray-600">
                            <li>Input the count for all cards, epiphanies, conversions, removals, and duplications acquired during your run.</li>
                            <li>"Total Removal" mean all Neutral Card that you can buy from shop if you remove any of it put number in the box.</li>
                            <li>"Char. Removals" mean all basic card on a character that you removed. put a number in the box if you do remove</li>
                            <li>"Total Duplications" exactly as the name if you dupe 2 then put 2.</li>
                            <li>Variable Cost Mechanics (Section 4):
                                <ul class="list-circle list-inside ml-4">
                                    <li>Total Removals & Total Duplications (Normal Cards): Incremental costs are 0, 10, 30, 50, 70, 70...</li>
                                    <li>Char. Removals: Incremental costs are 20, 30, 50, 70, 70...</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ol>
                <p class="mt-4 text-sm text-gray-500">Okay, that is all I can explain if you still don't get it go check the full rules on reddit.</p>
                <li> <a href="https://www.reddit.com/r/ChaosZeroNightmare/comments/1ouxsbc/confirmed_save_data_rules_according_to_new/">Click here to go.</a> </li>
            </div>
        </div>
    </main>

    <div id="floatingResetContainer" class="fixed bottom-4 right-4 z-60 space-y-2 flex flex-col items-end"> 
        <button id="floatingResetButton" onclick="triggerCharacterReset()" class="py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-full shadow-lg transition duration-150 transform hover:scale-105">
            Reset Active Character
        </button>
    </div>


    <script>
        const STORAGE_KEY = 'czn_faint_memory_state';
        const SKIP_MODAL_KEY = 'czn_skip_reset_confirmation';

        const CHARACTER_NAMES = [
            "Luke", "Khalipe", "Magna", "Rin", "Orlea", "Mei Lin", "Veronica", "Renoa", 
            "Hugo", "Yuki", "Haru", "Kayron", "Nia", "Selana", "Tressa", "Amir", 
            "Lucas", "Maribell", "Mika", "Beryl", "Cassius", "Rei", "Owen (NTR GOD)"
        ];
        const NUM_TOTAL_CHARACTERS = CHARACTER_NAMES.length; 
        const NUM_ACTIVE_SLOTS = 3;

        // Variables that will hold state
        let characterDatabase = [];
        let activeSlots = [0, 1, 2]; 
        let activeSlotIndex = 0; 
        
        // --- Core Calculation Logic ---

        function calculateVariableCost(count) {
            if (count <= 0) return 0;
            const costs = [0, 10, 30, 50, 70];
            let total = 0;
            for (let i = 1; i <= count; i++) {
                const costIndex = Math.min(i - 1, costs.length - 1);
                total += costs[costIndex]; 
            }
            return total;
        }

        function calculateCharRemovalCost(count) {
            if (count <= 0) return 0;
            const costs = [20, 30, 50, 70, 70]; 
            let total = 0;
            for (let i = 1; i <= count; i++) {
                const costIndex = Math.min(i - 1, costs.length - 1);
                total += costs[costIndex]; 
            }
            return total;
        }

        // --- State Initialization and Local Storage Management ---

        function getInitialCharacterInputs() {
             return {
                difficultyTier: 5,
                nightmareMode: false,
                codexModifier: 0,
                neutralCards: 0,
                forbiddenCards: 0,
                monsterCards: 0,
                monsterCardValue: 80, 
                regEpiphany: 0,
                divineEpiphany: 0,
                cardConversion: 0,
                removalsCount: 0, 
                charCardRemoval: 0, 
                duplicationsCount: 0, 
            };
        }
        
        function getInitialCharacterState(name) {
             return {
                name: name,
                inputs: getInitialCharacterInputs(),
                limit: 70,
                totalPoints: 0,
            };
        }
        
        /**
         * Saves the current state to the browser's localStorage.
         */
        function persistData() {
            saveCurrentInputs(); 

            const stateToSave = {
                characterDatabase: characterDatabase,
                activeSlots: activeSlots,
                activeSlotIndex: activeSlotIndex
            };
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        }

        /**
         * Attempts to load state from localStorage, initializing defaults if none is found.
         */
        function loadData() {
            try {
                const savedState = localStorage.getItem(STORAGE_KEY);
                if (savedState) {
                    const data = JSON.parse(savedState);
                    
                    if (data.characterDatabase && data.activeSlots) {
                        characterDatabase = data.characterDatabase;
                        activeSlots = data.activeSlots;
                        activeSlotIndex = data.activeSlotIndex !== undefined ? data.activeSlotIndex : 0;
                        console.log("State loaded from localStorage.");
                        return;
                    }
                }
            } catch (e) {
                console.warn("Could not load state from localStorage. Initializing default state.", e);
            }
            
            // Initialize default state if loading failed or no data was found
            characterDatabase = [];
            for (let i = 0; i < NUM_TOTAL_CHARACTERS; i++) {
                characterDatabase.push(getInitialCharacterState(CHARACTER_NAMES[i]));
            }
            activeSlots = [0, 1, 2];
            activeSlotIndex = 0;
        }


        function saveCurrentInputs() {
            if (!document.getElementById('difficultyTier')) return;
            
            const dbIndex = activeSlots[activeSlotIndex];
            const inputs = characterDatabase[dbIndex].inputs;
            
            const getValue = (id, isCheckbox = false) => {
                const el = document.getElementById(id);
                if (!el) return 0;
                if (isCheckbox) return el.checked;
                return el.type === 'number' ? parseInt(el.value) || 0 : parseInt(el.value);
            };

            inputs.difficultyTier = getValue('difficultyTier');
            inputs.nightmareMode = getValue('nightmareMode', true);
            inputs.codexModifier = getValue('codexModifier');
            inputs.neutralCards = getValue('neutralCards');
            inputs.forbiddenCards = getValue('forbiddenCards');
            inputs.monsterCards = getValue('monsterCards');
            inputs.monsterCardValue = getValue('monsterCardValue');
            inputs.regEpiphany = getValue('regEpiphany');
            inputs.divineEpiphany = getValue('divineEpiphany');
            inputs.cardConversion = getValue('cardConversion');
            inputs.removalsCount = getValue('removalsCount');
            inputs.charCardRemoval = getValue('charCardRemoval');
            inputs.duplicationsCount = getValue('duplicationsCount');
        }
        
        /**
         * Switches the active slot index and updates the UI.
         */
        function switchSlot(direction) {
            persistData(); 

            let newIndex = activeSlotIndex + direction;
            if (newIndex < 0) {
                newIndex = NUM_ACTIVE_SLOTS - 1; 
            } else if (newIndex >= NUM_ACTIVE_SLOTS) {
                newIndex = 0;
            }
            
            activeSlotIndex = newIndex;
            document.getElementById('slotSelector').value = activeSlotIndex;

            renderCurrentCharacterInputs();
            calculateAndUpdate();
            persistData(); 
        }

        // Handler for switching between Slot 1, 2, or 3 via dropdown
        function handleSlotSwitch(slotIndexStr) {
            persistData(); 
            activeSlotIndex = parseInt(slotIndexStr);
            
            renderCurrentCharacterInputs();
            calculateAndUpdate();
            persistData(); 
        }

        // Handler for selecting a new character from the 23-list into the active slot
        function handleCharacterSelect(newDbIndexStr) {
            persistData(); 
            const newDbIndex = parseInt(newDbIndexStr);
            
            activeSlots[activeSlotIndex] = newDbIndex;

            const slotSelector = document.getElementById('slotSelector');
            slotSelector.options[activeSlotIndex].textContent = `Slot ${activeSlotIndex + 1}: ${characterDatabase[newDbIndex].name}`;

            renderCurrentCharacterInputs(); 
            calculateAndUpdate();
            persistData(); 
        }

        // --- Reset Logic (Split Buttons and Modal Skip) ---

        function isModalSkipEnabled() {
            return localStorage.getItem(SKIP_MODAL_KEY) === 'true';
        }

        function toggleModalSkip(checked) {
            localStorage.setItem(SKIP_MODAL_KEY, checked);
        }

        // Main entry points for floating buttons
        function triggerCharacterReset() {
            if (isModalSkipEnabled()) {
                resetCharacterInputs('all');
            } else {
                showCharacterResetModal();
            }
        }
        function triggerGlobalReset() {
            if (isModalSkipEnabled()) {
                resetAllCharacters();
            } else {
                showGlobalResetModal();
            }
        }
        
        function hideResetModal() {
            document.getElementById('resetModal').classList.add('hidden');
        }

        function showCharacterResetModal() {
            const dbIndex = activeSlots[activeSlotIndex];
            const charName = characterDatabase[dbIndex].name;
            
            document.getElementById('modalTitle').textContent = `Confirm Reset for ${charName}`;
            document.getElementById('modalMessage').innerHTML = `You are about to reset the data for **<span class="font-semibold text-indigo-600">${charName}</span>**. Please choose a reset scope.`;
            
            document.getElementById('resetOptions').innerHTML = `
                <button onclick="resetCharacterInputs('variable')" class="w-full py-3 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg shadow-md transition duration-150">
                    Reset Variable Inputs Only (Removals/Duplications)
                </button>
                <button onclick="resetCharacterInputs('all')" class="w-full py-3 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                    Reset ALL Inputs (Full Character Reset)
                </button>
            `;
            
            document.getElementById('skipConfirmationCheckbox').checked = isModalSkipEnabled();
            document.getElementById('resetModal').classList.remove('hidden');
        }
        
        function showGlobalResetModal() {
            document.getElementById('modalTitle').textContent = `Confirm GLOBAL Data Reset`;
            document.getElementById('modalMessage').innerHTML = `You are about to **PERMANENTLY RESET** the inputs for <span class="font-semibold text-red-600">ALL 23 CHARACTERS</span>. This action cannot be undone.`;
            
            document.getElementById('resetOptions').innerHTML = `
                <button onclick="resetAllCharacters()" class="w-full py-3 px-4 bg-red-800 hover:bg-red-900 text-white font-semibold rounded-lg shadow-md transition duration-150">
                    CONFIRM: Reset ALL 23 Characters
                </button>
            `;
            
            document.getElementById('skipConfirmationCheckbox').checked = isModalSkipEnabled();
            document.getElementById('resetModal').classList.remove('hidden');
        }

        /**
         * Resets inputs for the current active character.
         * @param {string} mode - 'all' or 'variable'.
         */
        function resetCharacterInputs(mode) {
            const dbIndex = activeSlots[activeSlotIndex];
            const state = characterDatabase[dbIndex];
            const defaults = getInitialCharacterInputs();
            
            if (mode === 'all') {
                state.inputs = defaults;
            } else if (mode === 'variable') {
                state.inputs.removalsCount = defaults.removalsCount;
                state.inputs.charCardRemoval = defaults.charCardRemoval;
                state.inputs.duplicationsCount = defaults.duplicationsCount;
            }
            
            hideResetModal();
            renderCurrentCharacterInputs();
            calculateAndUpdate();
        }
        
        /**
         * Resets all inputs for all 23 characters and resets active slots to default.
         */
        function resetAllCharacters() {
            // Reset all 23 character inputs
            for (let i = 0; i < NUM_TOTAL_CHARACTERS; i++) {
                characterDatabase[i].inputs = getInitialCharacterInputs();
            }
            // Reset active slots back to [Luke, Khalipe, Magna] and Slot 1 active
            activeSlots = [0, 1, 2];
            activeSlotIndex = 0;
            
            hideResetModal();
            
            // Re-initialize to refresh all UI components
            initializeApp(); 
        }

        // --- Calculation and Display Function ---

        function calculateAndUpdate() {
            saveCurrentInputs();
            
            const dbIndex = activeSlots[activeSlotIndex];
            const state = characterDatabase[dbIndex];
            const inputs = state.inputs;

            // 1. Calculate Limit
            let runTier = inputs.difficultyTier;
            if (inputs.nightmareMode) { runTier += 1; }
            runTier += inputs.codexModifier;
            const pointLimit = 30 + 10 * (runTier - 1);
            
            // 2. Calculate Total Points (Faint Memory)
            let totalPoints = 0;
            totalPoints += inputs.neutralCards * 20;
            totalPoints += inputs.forbiddenCards * 20;
            totalPoints += inputs.monsterCards * inputs.monsterCardValue;
            totalPoints += inputs.regEpiphany * 10;
            totalPoints += inputs.divineEpiphany * 20;
            totalPoints += inputs.cardConversion * 10;
            
            totalPoints += calculateVariableCost(inputs.removalsCount);
            totalPoints += calculateCharRemovalCost(inputs.charCardRemoval); 
            totalPoints += calculateVariableCost(inputs.duplicationsCount);

            // 3. Update state with results (in the database)
            state.limit = pointLimit;
            state.totalPoints = totalPoints;

            // 4. Update UI displays
            renderCurrentCharacterResults(state);
            updateSummaryDisplay();
            
            // Automatically save any change to localStorage
            persistData();
        }
        
        function toggleGuide() {
            const guideContent = document.getElementById('guideContent');
            const toggleIcon = document.getElementById('toggleIcon');
            const isHidden = guideContent.classList.contains('hidden');

            if (isHidden) {
                guideContent.classList.remove('hidden');
                toggleIcon.style.transform = 'rotate(180deg)';
            } else {
                guideContent.classList.add('hidden');
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        }

        // --- Rendering Functions ---

        function populateCharacterPicker() {
            const picker = document.getElementById('characterPicker');
            picker.innerHTML = '';
            CHARACTER_NAMES.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = name;
                picker.appendChild(option);
            });
            picker.value = activeSlots[activeSlotIndex];
        }

        function updateSummaryDisplay() {
            const summaryBar = document.getElementById('summaryBar');
            summaryBar.innerHTML = ''; 
            const slotSelector = document.getElementById('slotSelector');

            for (let slot = 0; slot < NUM_ACTIVE_SLOTS; slot++) {
                const dbIndex = activeSlots[slot];
                const state = characterDatabase[dbIndex];
                
                const isExceeded = state.totalPoints > state.limit;
                const totalText = state.totalPoints.toLocaleString();
                const statusColor = isExceeded ? 'bg-red-50 text-red-600 border-red-300' : 'bg-green-50 text-green-600 border-green-300';
                
                const isActive = slot === activeSlotIndex ? 'ring-2 ring-indigo-500 ring-offset-2' : '';

                slotSelector.options[slot].textContent = `Slot ${slot + 1}: ${state.name}`;

                summaryBar.innerHTML += `
                    <div class="text-center p-3 rounded-xl border ${statusColor} ${isActive} cursor-pointer transition duration-150 ease-in-out hover:shadow-md" 
                         onclick="document.getElementById('slotSelector').value='${slot}'; handleSlotSwitch('${slot}')">
                        <p class="text-xs font-semibold uppercase truncate">${state.name}</p>
                        <p class="text-xl font-bold mt-1">${totalText}</p>
                        <p class="text-xs font-medium ${isExceeded ? 'text-red-500' : 'text-green-500'}">Limit: ${state.limit}</p>
                    </div>
                `;
            }
            slotSelector.value = activeSlotIndex;
        }

        function renderCurrentCharacterResults(state) {
            const isExceeded = state.totalPoints > state.limit;
            const statusBox = document.getElementById('statusBox');
            const statusDisplay = document.getElementById('statusDisplay');
            
            const effectiveTier = state.inputs.difficultyTier + (state.inputs.nightmareMode ? 1 : 0) + state.inputs.codexModifier;
            
            document.getElementById('limitDisplay').textContent = `${state.limit.toLocaleString()} (T${effectiveTier})`;
            document.getElementById('totalPointsDisplay').textContent = state.totalPoints.toLocaleString();
            
            document.getElementById('characterStatus').textContent = `Editing: ${state.name}`;

            if (isExceeded) {
                const exceededBy = state.totalPoints - state.limit;
                statusDisplay.textContent = `EXCEEDED by ${exceededBy.toLocaleString()}`;
                statusBox.className = 'text-center p-3 rounded-lg bg-red-100 border-2 border-red-300';
                statusDisplay.className = 'text-xl font-extrabold text-red-700 mt-1';
            } else {
                statusDisplay.textContent = 'SAFE';
                statusBox.className = 'text-center p-3 rounded-lg bg-green-100 border-2 border-green-300';
                statusDisplay.className = 'text-xl font-extrabold text-green-700 mt-1';
            }
        }

        function renderCurrentCharacterInputs() {
            const container = document.getElementById('calculatorForm');
            const dbIndex = activeSlots[activeSlotIndex];
            const state = characterDatabase[dbIndex];
            const inputs = state.inputs;
            const onChange = `calculateAndUpdate()`;

            container.innerHTML = `
                <div class="p-4 border border-indigo-200 rounded-xl bg-indigo-50">
                    <h2 class="text-xl font-bold text-indigo-800 mb-3">1. Point Limit Modifiers for ${state.name}</h2>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label for="difficultyTier" class="block text-sm font-medium text-gray-700 mb-1">Base Difficulty Tier</label>
                            <select id="difficultyTier" onchange="${onChange}">
                                ${Array.from({ length: 30 }, (_, i) => i + 1).map(tier => 
                                    `<option value="${tier}" ${inputs.difficultyTier === tier ? 'selected' : ''}>Tier ${tier} ${tier === 1 ? '(Base)' : ''} ${tier === 30 ? '(Max)' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="nightmareMode" class="flex items-center text-sm font-medium text-gray-700 cursor-pointer">
                                <input type="checkbox" id="nightmareMode" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" onchange="${onChange}" ${inputs.nightmareMode ? 'checked' : ''}>
                                <span class="ml-2">Nightmare Mode (Tier +1)</span>
                            </label>
                        </div>
                        <div class="input-group">
                            <label for="codexModifier" class="block text-sm font-medium text-gray-700 mb-1">Codex Modifiers (Tier +X)</label>
                            <select id="codexModifier" onchange="${onChange}">
                                <option value="0" ${inputs.codexModifier === 0 ? 'selected' : ''}>None (+0)</option>
                                <option value="1" ${inputs.codexModifier === 1 ? 'selected' : ''}>Mild (+1)</option>
                                <option value="2" ${inputs.codexModifier === 2 ? 'selected' : ''}>Hard (+2)</option>
                            </select>
                        </div>
                        <p class="text-xs text-gray-500 pt-2 border-t border-gray-200">Limit Formula: 30 + 10 x (Effective Tier - 1)</p>
                    </div>
                </div>

                <div class="p-4 border border-blue-200 rounded-xl bg-blue-50">
                    <h2 class="text-xl font-bold text-blue-800 mb-3">2. Card Obtained (Faint Memory)</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="neutralCards" class="block text-sm font-medium text-gray-700 mb-1">Neutral Cards (+20)</label>
                            <input type="number" id="neutralCards" min="0" value="${inputs.neutralCards}" oninput="${onChange}">
                        </div>
                        <div class="input-group">
                            <label for="forbiddenCards" class="block text-sm font-medium text-gray-700 mb-1">Forbidden Cards (+20)</label>
                            <input type="number" id="forbiddenCards" min="0" value="${inputs.forbiddenCards}" oninput="${onChange}">
                        </div>
                        <div class="input-group col-span-2">
                            <label for="monsterCards" class="block text-sm font-medium text-gray-700 mb-1">Monster Cards (Count)</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="monsterCards" min="0" value="${inputs.monsterCards}" class="flex-grow" oninput="${onChange}">
                                <select id="monsterCardValue" onchange="${onChange}" class="w-32">
                                    <option value="80" ${inputs.monsterCardValue === 80 ? 'selected' : ''}>+80 Value</option>
                                    <option value="70" ${inputs.monsterCardValue === 70 ? 'selected' : ''}>+70 (Reported)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 border border-green-200 rounded-xl bg-green-50">
                    <h2 class="text-xl font-bold text-green-800 mb-3">3. Epiphanies & Conversions 
                                <p class="text-xs text-blue-700 mb-4"> All Character Regular Epiphanies always count +0 </p></h2>
                    <div class="grid grid-cols-3 gap-4">    
                        <div class="input-group">
                            <label for="regEpiphany" class="block text-sm font-medium text-gray-700 mb-1">Reg. Epiphany (+10)</label>
                            <input type="number" id="regEpiphany" min="0" value="${inputs.regEpiphany}" oninput="${onChange}">
                        </div>
                        <div class="input-group">
                            <label for="divineEpiphany" class="block text-sm font-medium text-gray-700 mb-1">Divine Epiphany (+20)</label>
                            <input type="number" id="divineEpiphany" min="0" value="${inputs.divineEpiphany}" oninput="${onChange}">
                        </div>
                        <div class="input-group">
                            <label for="cardConversion" class="block text-sm font-medium text-gray-700 mb-1">Card Conversions (+10)</label>
                            <input type="number" id="cardConversion" min="0" value="${inputs.cardConversion}" oninput="${onChange}">
                        </div>
                    </div>
                </div>

                <div class="p-4 border border-red-200 rounded-xl bg-red-50">
                    <h2 class="text-xl font-bold text-red-800 mb-3">4. Removals & Duplications (Variable Cost)</h2>
                    <p class="text-xs text-red-700 mb-4">
                        Starting Card Costs (Removals/Duplications): 0, 10, 30, 50, 70
                        <br> Character's Cards (Variable): 20, 30, 50, 70
						<br> Quick Guide: "Total Removals" is total all Neutral Card that you removed eg. put number like 2, 4 </p>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="input-group">
                            <label for="removalsCount" class="block text-sm font-medium text-gray-700 mb-1">Total Removals</label>
                            <input type="number" id="removalsCount" min="0" value="${inputs.removalsCount}" oninput="${onChange}">
                        </div>
                        <div class="input-group">
                            <label for="charCardRemoval" class="block text-sm font-medium text-gray-700 mb-1">Char. Removals (20, 30, 50, 70)</label>
                            <input type="number" id="charCardRemoval" min="0" value="${inputs.charCardRemoval}" oninput="${onChange}">
                        </div>
                        <div class="input-group">
                            <label for="duplicationsCount" class="block text-sm font-medium text-gray-700 mb-1">Total Duplications (Variable)</label>
                            <input type="number" id="duplicationsCount" min="0" value="${inputs.duplicationsCount}" oninput="${onChange}">
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('characterPicker').value = dbIndex;
        }
        
        // --- Initialization ---

        function initializeApp() {
            loadData();
            populateCharacterPicker();
            renderCurrentCharacterInputs(); 
            updateSummaryDisplay(); 
            calculateAndUpdate();
            
            // Set the checkbox status on load
            document.getElementById('skipConfirmationCheckbox').checked = isModalSkipEnabled();
        }

        window.onload = initializeApp;
    </script>
</body>
</html>